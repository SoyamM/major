<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Major Project</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
    * {margin:0; padding:0; box-sizing:border-box;}

    body {
      height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      flex-direction:column;
      background: radial-gradient(circle at 30% 30%, #443256 0%, #0f023d 60%, #595656 100%);
      overflow:hidden;
      font-family:"Poppins", sans-serif;
      color:#fff;
      position:relative;
    }

    header {
      font-size:2rem;
      font-weight:600;
      margin-bottom:60px;
      text-shadow:0 0 25px rgba(255,255,255,0.4);
      z-index:3;
    }

    #threedd {
      position:absolute;
      width:1000px;
      height:900px;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      z-index:0;
      opacity:0.9;
      filter:brightness(1.3) contrast(1.2);
      pointer-events:none;
    }

    .glass-container {
      display:flex;
      gap:100px;
      z-index:2;
    }

    .glass-box {
      width:180px;
      height:180px;
      background:rgba(255,255,255,0.07);
      border-radius:40px;
      border:1px solid rgba(255,255,255,0.2);
      backdrop-filter:blur(8px);
      box-shadow:
        inset 2px 2px 10px rgba(255,255,255,0.25),
        inset -2px -2px 10px rgba(0,0,0,0.5),
        0 0 25px rgba(255,255,255,0.05);
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:1.3rem;
      font-weight:600;
      color:#fff;
      cursor:pointer;
      transition:all 0.4s ease;
      position:relative;
    }

    .glass-box::before {
      content:"";
      position:absolute;
      inset:0;
      border-radius:40px;
      background:linear-gradient(145deg, rgba(255,255,255,0.3), rgba(255,255,255,0));
      opacity:0.6;
      pointer-events:none;
    }

    .glass-box:hover {
      transform:translateY(-10px) scale(1.08);
      background:rgba(255,255,255,0.12);
      box-shadow:
        inset 3px 3px 12px rgba(255,255,255,0.35),
        inset -3px -3px 12px rgba(0,0,0,0.6),
        0 0 40px rgba(255,255,255,0.2);
    }

    footer {
      position:absolute;
      bottom:25px;
      font-size:14px;
      opacity:0.8;
      z-index:3;
    }

    /* CAMERA MODAL */
    #camera-modal {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:20;
    }
    #video-container {
      background:rgba(255,255,255,0.1); padding:30px; border-radius:20px;
      backdrop-filter:blur(10px); text-align:center;
    }
    #video {width:320px; height:240px; border-radius:15px; border:2px solid rgba(255,255,255,0.3);}
    #status {margin:20px 0; font-size:1.2rem; font-weight:600;}
    .small-glass {width:120px; height:45px; font-size:1rem; margin:10px;}

    /* LOADING SPINNER */
    #loading {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.9); z-index:30; justify-content:center; align-items:center;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <header>Major Project</header>

  <!-- 3D Robot -->
  <model-viewer id="threedd" src="/static/robot_playground.glb"
                autoplay auto-rotate camera-controls shadow-intensity="1" exposure="1.3" disable-zoom>
  </model-viewer>

  <!-- TWO BUTTONS -->
  <div class="glass-container">
    <div class="glass-box" id="start-btn">Start Recognition</div>
    <div class="glass-box" id="manual-admin-btn">Manual Admin Login</div>
  </div>

  <footer>AI-Powered Access Control System</footer>

  <!-- CAMERA MODAL -->
  <div id="camera-modal">
    <div id="video-container">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <div id="status">Position your face clearly</div>
      <div class="glass-container">
        <div class="glass-box small-glass" id="capture-btn">Capture</div>
        <div class="glass-box small-glass" id="cancel-btn">Cancel</div>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loading">
    <div style="text-align:center;">
      <div style="font-size:3rem; margin-bottom:20px;">Robot</div>
      <div style="font-size:1.5rem; font-weight:600;">Analyzing Face...</div>
      <div style="margin-top:20px; width:50px; height:50px; border:3px solid rgba(255,255,255,0.3); border-top:3px solid #fff; border-radius:50%; animation: spin 1s linear infinite; margin:0 auto;"></div>
    </div>
  </div>

  <!-- Model Viewer -->
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>

  <!-- MAIN SCRIPT -->
  <script>
    // Elements
    const startBtn       = document.getElementById('start-btn');
    const cameraModal    = document.getElementById('camera-modal');
    const video          = document.getElementById('video');
    const canvas         = document.getElementById('canvas');
    const ctx            = canvas.getContext('2d');
    const captureBtn     = document.getElementById('capture-btn');
    const cancelBtn      = document.getElementById('cancel-btn');
    const loading        = document.getElementById('loading');
    const manualAdminBtn = document.getElementById('manual-admin-btn');
    const status         = document.getElementById('status');

    let stream;

    // === MANUAL ADMIN LOGIN WITH PASSWORD 0000 ===
    manualAdminBtn.addEventListener('click', () => {
      const pass = prompt('Enter Admin Password:', '');
      if (pass === '0000') {
        window.location.href = '/admin?name=ManualAdmin';
      } else if (pass !== null) {
        alert('Wrong password!');
      }
    });

    // === START RECOGNITION ===
    startBtn.addEventListener('click', async () => {
      cameraModal.style.display = 'flex';
      status.textContent = 'Position your face clearly';
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        video.srcObject = stream;
      } catch (err) {
        status.textContent = 'Camera access denied!';
        console.error(err);
      }
    });

    // === CAPTURE PHOTO ===
    captureBtn.addEventListener('click', async () => {
      if (!video.srcObject) return;

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      loading.style.display = 'flex';
      cameraModal.style.display = 'none';

      const imageData = canvas.toDataURL('image/jpeg', 0.8);

      try {
        const response = await fetch('/recognize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: imageData })
        });

        const result = await response.json();

        setTimeout(() => {
          if (result.is_admin) {
            window.location.href = `/admin?name=${encodeURIComponent(result.name)}`;
          } else {
            window.location.href = '/guest';
          }
        }, 1500);
      } catch (err) {
        loading.style.display = 'none';
        alert('Recognition failed. Try again.');
        console.error(err);
      }
    });

    // === CANCEL ===
    cancelBtn.addEventListener('click', () => {
      cameraModal.style.display = 'none';
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    });

    // Cleanup
    window.addEventListener('beforeunload', () => {
      if (stream) stream.getTracks().forEach(t => t.stop());
    });
  </script>
</body>
</html>